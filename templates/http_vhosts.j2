<VirtualHost *:80>
    ServerName {{ item.servername }}
    {% if item.serveralias != '' %}
    ServerAlias {{ item.serveralias }}
    {% endif %}

    DocumentRoot /var/www/html/{{ item.documentroot }}

{% if item.redirecttarget != '' %}
    ### alte version als variable ###
    RewriteEngine On
    Redirect permanent / {{ item.redirecttarget }}
{%  endif %}

{% if item.redirect != '' %}
    ### neue version als dict ###
    RewriteEngine On
{% for redirect in item.redirect %}
    {{ redirect.col }}
{% endfor %}
{% endif %}

    {% if item.non_www2www_redirect == 'true' %}
    RewriteEngine On
    RewriteCond %{HTTP_HOST} !^www\. [NC]
    RewriteRule ^ (.*)$ http://www.%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
    {% endif %}

    {% if item.basic_authentication == 'true' %}
    <Location />
        AuthType Basic
        AuthName "Authentication Required"
        AuthUserFile "/etc/apache2/.htpasswd"

        Require valid-user

        Order deny,allow
        Deny from all
        Allow from {{ server_ip }} 127.0.0.1
        Allow from env=page_speed_insights

        satisfy any
    </Location>
    {% endif %}

    <IfModule mod_fastcgi.c>
        <FilesMatch \.php$>
            SetHandler "proxy:unix:/var/run/php/php{( php_version )}-fpm.sock|fcgi://localhost/"
        </FilesMatch>
    </IfModule>

    {% if item.serveradmin != '' %}
    ServerAdmin {{ item.serveradmin }}
    {% endif %}

    {% if item.proxypasses != '' %}
#    ProxyRequests Off
    ProxyPreserveHost On
    {% for pp in item.proxypasses %}
    <Location {{ pp.location}}>
    ProxyPass {{ pp.pass }}
    {% if pp.reverse != '' %}
    ProxyPassReverse {{ pp.reverse }}
    {% endif %}
    </Location>
    {% endfor %}
#    AllowEncodedSlashes     NoDecode
    {% endif %}

    <Directory "/var/www/html/{{ item.documentroot }}">
        AllowOverride All
        Options Indexes FollowSymLinks MultiViews
        Order allow,deny
        Allow from all
        <LimitExcept HEAD POST GET>
            Deny from all
        </LimitExcept>
#        Require all granted
    </Directory>

    LogLevel {{ item.loglevel }} rewrite:trace3

    ErrorLog ${APACHE_LOG_DIR}/error_{{ item.logfilename }}.log
    CustomLog ${APACHE_LOG_DIR}/access_{{ item.logfilename }}.log combined
</VirtualHost>
