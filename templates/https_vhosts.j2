{% if item.aliases != '' %}
	{% for alias in item.aliases %}
		Alias {{ alias.col }}
	{% endfor %}
{% endif %}

<VirtualHost *:443>
    ServerName {{ item.servername }}
    {% if item.serveralias != '' %}
    ServerAlias {{ item.serveralias }}
    {% endif %}

{% if item.sni_enabled == 'true' %}
    SSLStrictSNIVHostCheck on
{% endif %}

{% if item.redirecttarget != '' %}
    ### alte version als variable ###
	RewriteEngine On
	Redirect permanent / {{ item.redirecttarget }}
{%  endif %}

{% if item.redirect != '' %}
    ### neue version als dict ###
    RewriteEngine On
{% for redirect in item.redirect %}
    {{ redirect.col }}
{% endfor %}
{% endif %}

    DocumentRoot /var/www/html/{{ item.documentroot }}

    {% if item.non_www2www_redirect == 'true' %}
    RewriteEngine On
    RewriteCond %{HTTP_HOST} !^www\. [NC]
    RewriteRule ^(.*)$ http://www.%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
    {% endif %}

    {% if item.basic_authentication == 'true' %}
    <Location />
        AuthType Basic
        AuthName "Authentication Required"
        AuthUserFile "/etc/apache2/.htpasswd"

        Require valid-user

        Order deny,allow
        Deny from all
        Allow from {{ server_ip }}  127.0.0.1
        Allow from env=page_speed_insights

        satisfy any
    </Location>
    {% endif %}

    <IfModule mod_fastcgi.c>
        <FilesMatch \.php$>
            SetHandler "proxy:unix:/var/run/php/php{( php_version )}-fpm.sock|fcgi://localhost/"
        </FilesMatch>
    </IfModule>

    {% if item.serveradmin != '' %}
    ServerAdmin {{ item.serveradmin }}
    {% endif %}

    {% if item.proxypasses != '' %}
#    ProxyRequests Off
    ProxyPreserveHost On
    {% for pp in item.proxypasses %}
    <Location {{ pp.location}}>
    ProxyPass {{ pp.pass }}
    {% if pp.reverse != '' %}
    ProxyPassReverse {{ pp.reverse }}
    {% endif %}
    </Location>
    {% endfor %}
#    AllowEncodedSlashes     NoDecode
    {% endif %}

    <Directory "/var/www/html/{{ item.documentroot }}">
        AllowOverride All
        Options Indexes FollowSymLinks MultiViews
        Order allow,deny
        Allow from all
        <LimitExcept HEAD POST GET>
            Deny from all
        </LimitExcept>
#        Require all granted
    </Directory>

    LogLevel {{ item.loglevel }} ssl:error

    ErrorLog ${APACHE_LOG_DIR}/error_{{ item.logfilename }}.log
    CustomLog ${APACHE_LOG_DIR}/access_{{ item.logfilename }}.log combined


    SSLEngine on

    SSLCertificateFile      {{ ssl_certs_dir }}{{ item.cert_file }}
    SSLCertificateKeyFile   {{ ssl_keys_dir }}{{ item.key_file }}

    SSLProtocol +TLSv1.2
    SSLCipherSuite "ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS"
    SSLHonorCipherOrder on

    Header set Strict-Transport-Security "max-age=31536000"

    Header edit Set-Cookie ^(.*)$ $1;Secure

	{% if item.ssl_chain_certificate != '' %}
    SSLCertificateChainFile {{ ssl_certs_dir }}{{ item.ssl_chain_certificate }}
	{% endif %}

    <FilesMatch "\.(cgi|shtml|phtml|php)$">
                    SSLOptions +StdEnvVars
    </FilesMatch>
    <Directory /usr/lib/cgi-bin>
                    SSLOptions +StdEnvVars
    </Directory>

    BrowserMatch "MSIE [2-6]" \
                    nokeepalive ssl-unclean-shutdown \
                    downgrade-1.0 force-response-1.0
    # MSIE 7 and newer should be able to use keepalive
    BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown
</VirtualHost>
